# ============================================================================
# KWALA Workflow #2: Automated Weekly Scholarship Payroll
# Runs every Friday at 5 PM to batch pay all approved students
# ============================================================================

Name: "EduChain-Weekly-Scholarship-Payroll"

Execution:
  Mode: "sequential"

Trigger:
  RepeatEvery: "0 17 * * 5"  # Cron: Every Friday at 5:00 PM UTC
  RecurringChainID: 11155111  # Sepolia Testnet
  Meta: "Automated weekly scholarship disbursement"

Actions:
  # ============================================================================
  # Action 1: Get List of Approved But Unpaid Students
  # ============================================================================
  - Name: "GetApprovedStudentsList"
    Type: "api"
    APIEndpoint: "https://your-backend-url.com/api/kwala/get-approved-students"
    APIPayload: '{"poolFactoryAddress": "0x5D2B277be75CAB114189dE5298F2bC875Fa2a14a", "chainId": 11155111}'
    RetriesUntilSuccess: 3
    Metadata: "Backend queries all pools and returns approved/unpaid students"

  # ============================================================================
  # Action 2: Batch Pay All Approved Students
  # ============================================================================
  - Name: "BatchPayScholarships"
    Type: "call"
    TargetContract: "{{GetApprovedStudentsList.poolAddress}}"
    TargetFunction: "batchPayScholarships"
    TargetParams: ["{{GetApprovedStudentsList.students}}"]
    EncodedABI: "0x"
    ChainID: 11155111
    RetriesUntilSuccess: 1
    Metadata: "Pays all approved students in single transaction"

  # ============================================================================
  # Action 3: Notify Students of Payment
  # ============================================================================
  - Name: "NotifyStudentsPayment"
    Type: "api"
    APIEndpoint: "https://your-backend-url.com/api/kwala/notify-payment"
    APIPayload: '{"students": "{{GetApprovedStudentsList.students}}", "poolAddress": "{{GetApprovedStudentsList.poolAddress}}", "txHash": "{{BatchPayScholarships.transactionHash}}"}'
    RetriesUntilSuccess: 1
    Metadata: "Sends payment confirmation emails to all students"

  # ============================================================================
  # Action 4: Log Payroll Run
  # ============================================================================
  - Name: "LogPayrollRun"
    Type: "api"
    APIEndpoint: "https://your-backend-url.com/api/kwala/log-payroll"
    APIPayload: '{"poolAddress": "{{GetApprovedStudentsList.poolAddress}}", "studentCount": "{{GetApprovedStudentsList.count}}", "success": true, "timestamp": "{{timestamp}}"}'
    RetriesUntilSuccess: 1
    Metadata: "Records payroll execution for analytics and monitoring"

# ============================================================================
# REQUIRED SETUP STEPS:
# ============================================================================
# 1. Ensure ALL scholarship pools have AUTOMATION_ROLE granted to KWALA wallet
#
# 2. Backend /api/kwala/get-approved-students must return:
#    {
#      "poolAddress": "0xPool1Address",
#      "students": ["0xStudent1", "0xStudent2"],
#      "count": 2
#    }
#
# 3. Ensure all pools have sufficient balance for payments
#
# 4. KWALA wallet must have enough Sepolia ETH for gas fees
#
# 5. Fund KWALA address with enough credits for weekly execution
#
# 6. Update this file:
#    - Replace "https://your-backend-url.com" with actual backend URL
#
# 7. Test with manual trigger first before enabling weekly schedule
#
# 8. Upload workflow to KWALA dashboard
#
# 9. Monitor first few runs to ensure proper execution
# ============================================================================
